---
name: video-generator
description: 将每个镜头的首帧图+参考图+运动提示词输入 Seedance 2.0 生成 8-15 秒视频片段。核心职责包括：从分镜脚本的导演动态描述翻译为 Seedance motion prompt、组装多模态输入包（首帧+参考图+文本）、选择生成模式（First Frame / Full Reference）、执行生成并验证质量与一致性。对于连续性链，step7 内部运行反馈循环：从视频实际尾帧提取下一镜头的首帧，实现基于真实画面的帧级连续性；当链内某镜头质量过差时，执行链条中断处理，回退到 step6 请求新锚点帧。
---

# 视频生成

## 定位

视频生成是整条流水线中**从静态画面到动态影像的飞跃**。

前六个阶段的全部工作——元素提取、风格定义、圣经编写、资产生成、分镜设计、首帧合成——都是为这一步做准备。本阶段将每个镜头的首帧图"激活"为 8-15 秒的视频片段，让角色动起来、让镜头推拉摇移、让光影随时间流动。

在好莱坞制作流程中，这对应 **Principal Photography（主摄影/拍摄）** 阶段——一切准备就绪，开机拍摄。区别在于：传统流程中"拍摄"由摄影师和演员完成；AI 制作流中，"拍摄"由 Seedance 2.0 根据首帧图 + 运动提示词 + 参考图自动生成。

**本阶段的核心技术挑战有四个**：
1. **Motion Prompt 工程**——将 step5 的中文导演动态描述翻译为 Seedance 可执行的英文运动指令，这与 step6 的 Image Prompt 工程是同构但不同的翻译任务
2. **生成模式选择**——Seedance 2.0 支持多种模式（First Frame / Full Reference），每个镜头需要根据画面复杂度选择最合适的模式
3. **连续性反馈循环**——连续性链内部的镜头不再由 step6 提供首帧，而是由 step7 从前一镜头视频的实际尾帧提取。这要求 step7 按严格的依赖顺序逐镜头生成，并在每个视频生成后提取尾帧用于下一镜头
4. **运动质量控制与链条中断**——AI 生成的运动可能出现质量问题，而在连续性链中，一个低质量视频的尾帧会污染后续所有镜头。需要建立质量评估标准、链条中断阈值和回退到 step6 的机制

## 核心原则

1. **首帧是基准**——视频的画面质量上限已被 step6 的首帧锁定。本阶段的工作是"让画面正确地动起来"，而不是修正首帧中的任何问题。如果首帧有问题，必须回到 step6 修正，不可在本阶段尝试弥补
2. **运动克制**——AI 视频生成对大幅度、快速、复杂的运动容易失控。宁可让动作比分镜描述稍慢、稍小，也不要让画面崩溃。如有需要，可在 step8 后期通过加速或剪辑节奏调整来弥补
3. **prompt 是桥梁**——与 step6 相同，本阶段需要将 step5 的导演意图翻译为 AI 工具的技术语言，但翻译目标从"静态画面"变为"运动过程"
4. **模式匹配场景**——不同类型的镜头适合不同的 Seedance 生成模式。选错模式会导致运动质量大幅下降
5. **一致性仍是生命线**——视频片段中的角色面貌必须与首帧一致，不能在运动过程中"变脸"。参考图注入是防止变脸的关键手段

## 输入

- `production/step6-keyframes/`——锚点帧图集
  - `{场次}/{镜号}_first.png`——锚点帧（仅链头镜头和独立镜头有）
  - `keyframe_index.md`——锚点帧索引（镜号→帧类型→连续性链关系）
- `production/step5-storyboard/storyboard/{SC{NNN}}.md`——分镜脚本（动态描述、运镜方式、音效提示、时长）
- `production/step5-storyboard/shot_list.md`——镜头表（运镜方式、时长的快速总览）
- `production/step4-assets/asset_index.md`——资产索引（参考图路径）
- `production/step4-assets/`——视觉资产库（角色肖像、阶段参考图）
- `production/step2-art-direction/art_direction.md`——全局视觉风格定义

**首帧来源规则**：
- **帧类型为"独立锚点""链头锚点""正反打锚点"**的镜头 → 首帧来自 step6 的 `{镜号}_first.png`
- **帧类型为"step7提供"**的镜头 → 首帧来自 step7 自身从前一镜头视频中提取的实际尾帧
- **帧类型为"中断回退锚点"**的镜头 → 首帧来自 step6 应急生成的新锚点帧

**研究方法**：
1. 先读 `keyframe_index.md`，明确总镜头数、连续性链结构（哪些镜头有 step6 锚点帧，哪些需要 step7 自行提供）
2. 读 `shot_list.md`，总览全部镜头的运镜和时长
3. 规划生成顺序：连续性链必须按链内顺序逐个生成，独立镜头可并行
4. 按场次顺序读取分镜脚本，逐镜头执行 motion prompt 翻译和生成

## 输出

`production/step7-clips/` 下的视频片段、提取的尾帧和生成日志：

```
production/step7-clips/
├── SC001/
│   ├── SC001-001.mp4                # 视频片段（8-15s）
│   ├── SC001-001_motion.md          # 该镜头的完整 motion prompt 记录
│   ├── SC001-001_tail.png           # 从视频末帧提取（仅连续性链内的镜头才需要）
│   ├── SC001-002.mp4
│   ├── SC001-002_motion.md
│   ├── SC001-002_tail.png           # 提取的尾帧 → 用作 SC001-003 的首帧
│   └── ...
├── SC002/
│   └── ...
├── ...
├── clip_index.md                    # 视频片段索引（镜号 → 文件路径 → 时长 → 质量评级 → 首帧来源）
└── generation_log.md                # 生成日志（参数、尝试次数、调整记录、链条中断记录）
```

**文件命名规则**：
- 视频片段：`{镜号}.mp4`
- Motion prompt 记录：`{镜号}_motion.md`
- 提取尾帧：`{镜号}_tail.png`（仅连续性链内、且后面还有链内镜头时生成）
- 按场次分子目录，目录名 = 场次编号

---

## Seedance 2.0 生成模式

### 两种核心模式及其适用场景

| 模式 | 输入 | 输出 | 适用场景 |
|------|------|------|---------|
| **First Frame** | 首帧图 + text prompt | 视频片段 | 所有镜头的基础模式——独立镜头、连续性链内镜头（首帧来自 step6 锚点帧或 step7 提取的尾帧） |
| **Full Reference** | 首帧图 + 参考图 + text prompt | 视频片段 | 角色一致性要求极高的镜头（角色特写、近景对话）——在 First Frame 基础上叠加角色肖像参考 |

**注意**：旧版 First-Last Frame 模式不再用于连续性保障。连续性现在由 step7 的反馈循环机制保障——前一视频的实际尾帧直接作为下一视频的首帧输入，无需预先生成尾帧图。

### 模式选择决策树

```
该镜头是否有角色特写/近景？
  │
  ├── 是 → Full Reference 模式（First Frame + 角色肖像锚点注入）
  │
  └── 否 → First Frame 模式（最通用）

注意：首帧来源由 keyframe_index.md 的帧类型决定：
  - "独立锚点/链头锚点/正反打锚点/中断回退锚点" → 来自 step6
  - "step7提供" → 来自前一镜头视频的提取尾帧
  模式选择与首帧来源无关，两者正交。
```

### 模式 + 首帧来源组合

| 首帧来源 | First Frame 模式 | Full Reference 模式 |
|---------|-----------------|-------------------|
| step6 锚点帧 | 独立远景/全景镜头 | 独立特写/近景镜头 |
| step7 提取尾帧 | 连续性链内远景/全景 | 连续性链内特写/近景 |
| step6 中断回退锚点帧 | 链条中断后的远景/全景 | 链条中断后的特写/近景 |

---

## Motion Prompt 工程：从导演动态描述到运动指令

### 与 step6 Image Prompt 工程的区别

| 维度 | step6 Image Prompt | step7 Motion Prompt |
|------|-------------------|-------------------|
| 描述对象 | 静止画面（第 0 秒） | 运动过程（0-Ns） |
| 核心内容 | 构图、光影、色彩、空间 | 动作、运镜、速度、节奏 |
| 来源段落 | step5"画面描述" | step5"动态描述"+"运镜方式" |
| 输出语言 | 英文，名词/形容词为主 | 英文，动词/副词为主 |
| 时间轴 | 无（冻结时刻） | 有（按秒描述变化） |

### Motion Prompt 结构

每个镜头的 motion prompt 由三个部分组成：

#### 部分一：镜头运动（Camera Motion）

来源：step5 镜头表的"运镜方式"字段。

将 step5 的中文运镜术语翻译为 Seedance 识别的英文指令：

| step5 中文 | Motion Prompt | 补充参数 |
|-----------|--------------|---------|
| 固定 | `static camera, locked shot` | — |
| 推（Dolly In） | `camera slowly dollies in` | `slow` / `steady` |
| 拉（Dolly Out） | `camera slowly dollies out` | `slow` / `revealing` |
| 摇（Pan） | `camera pans [left/right]` | `smooth pan` |
| 跟（Tracking） | `camera tracks the character, following movement` | `steady tracking` |
| 升（Crane Up） | `camera cranes up, rising` | `smooth crane` |
| 降（Crane Down） | `camera descends, craning down` | `smooth descent` |
| 环绕（Orbit） | `camera slowly orbits around the subject` | `360 orbit` / `partial orbit` |
| 手持 | `handheld camera, slight shake` | `documentary style` |
| 变焦推 | `camera zooms in` | `slow zoom` |
| 变焦拉 | `camera zooms out` | `slow zoom out` |

**运镜速度关键词**：
- 慢速：`slowly`, `gently`, `gradually`
- 中速：`steadily`, `smoothly`
- 快速：`quickly`, `rapidly`, `swiftly`（慎用——快速运镜容易导致画面撕裂）

#### 部分二：主体运动（Subject Motion）

来源：step5 分镜脚本的"动态描述"段落。

将角色/道具/环境的中文动作描述翻译为英文运动指令：

**翻译规则**：

1. **动词优先**——Motion prompt 的核心是动词，不是名词。`the man walks` 比 `a walking man` 更有效
2. **速度和力度要明确**——`slowly raises his hand` vs `quickly raises his hand` 会产生完全不同的运动
3. **角色不用真名**——与 step6 一致，使用通用描述（`the man`, `the woman`, `the figure`）
4. **分阶段描述**——与 step5 动态描述的时间轴对应，用 `then` / `after that` / `gradually` 等连接词串联
5. **环境运动也要描述**——风吹树叶、水面波纹、火焰跳动，这些环境动态对画面生动感至关重要

**翻译示例**：

```
step5 动态描述（中文）:
  0-3s: 朱围庸一动不动站在码头边，海风持续吹动衣衫
  3-7s: 他缓缓抬起右手，从怀中取出一个小瓷瓶，举到眼前端详
  7-10s: 他握紧瓷瓶，手臂缓缓放下，目光投向远处海面

      ↓ 翻译

Motion Prompt（部分二）:
  the man stands still at the dock edge, his robe gently
  fluttering in the sea breeze; then he slowly raises his
  right hand, pulling a small white porcelain bottle from
  inside his robe, holding it up to examine it closely;
  then he grips the bottle tightly, slowly lowers his arm,
  and gazes out toward the distant sea
```

#### 部分三：氛围与风格（Mood & Style）

来源：step5 分镜脚本的"音效提示"+ step2 Art Direction 的风格要素。

```
# 情绪氛围关键词
melancholic, contemplative, slow pace, somber mood

# 光影变化（如果镜头内光影有变化）
consistent golden hour lighting throughout

# 画面质感
cinematic, film grain, shallow depth of field
```

### Motion Prompt 组装

完整的 motion prompt 按以下顺序组装：

```
[部分一：镜头运动] + [部分二：主体运动] + [部分三：氛围风格]
```

**示例完整 prompt**：

```
static camera, locked shot;
the man stands still at the dock edge, his robe gently
fluttering in the sea breeze, then he slowly raises his
right hand pulling a small white porcelain bottle from
inside his robe, holding it up to examine it, then grips
the bottle tightly and slowly lowers his arm gazing toward
the distant sea;
melancholic contemplative mood, consistent golden hour
lighting, cinematic, subtle film grain
```

### Motion Prompt 记录文件格式

每个镜头生成一份 `{镜号}_motion.md`：

```markdown
# Motion Record: {镜号}

## 来源

- 分镜脚本：storyboard/{SC{NNN}}.md → 镜头 {镜号}
- 首帧来源：{step6锚点帧: step6-keyframes/{场次}/{镜号}_first.png / step7提取尾帧: step7-clips/{场次}/{前镜号}_tail.png / step6中断回退锚点帧: step6-keyframes/{场次}/{镜号}_first.png}

## 生成模式

{First Frame / Full Reference}

## Motion Prompt

\```
{部分一 + 部分二 + 部分三 的完整组装}
\```

## 参考图

| 用途 | 文件路径 | 说明 |
|------|---------|------|
| 首帧 | {来源路径，见上方"首帧来源"} | 视频起点 |
| 角色一致性 | characters/朱围庸/_portrait/正面半身像.png | Full Reference 锚点（如使用） |
| 角色阶段 | characters/朱围庸/占身乞丐期/*.png | Full Reference 形象参考（如使用） |

## 生成参数

| 参数 | 值 |
|------|-----|
| 时长 | {N}s |
| 分辨率 | {W}x{H} |
| Seed | {seed} |
| 生成批次 | {N} 次尝试 |
| 选中 | 第 {N} 次 |

## 质量评估

| 维度 | 评分 | 说明 |
|------|------|------|
| 运动自然度 | {A/B/C} | 动作是否流畅自然 |
| 角色一致性 | {A/B/C} | 运动过程中面貌是否保持一致 |
| 运镜执行 | {A/B/C} | 镜头运动是否与 prompt 匹配 |
| 物理合理性 | {A/B/C} | 有无穿模、漂浮、抖动 |
| 画面稳定性 | {A/B/C} | 有无闪烁、撕裂、模糊帧 |
| 首尾衔接 | {A/B/C/NA} | 与前后镜头的画面连续性 |
```

---

## 运动复杂度控制

### Seedance 2.0 的运动能力边界

AI 视频生成对不同复杂度的运动有不同的成功率：

| 运动复杂度 | 成功率 | 示例 | 策略 |
|-----------|--------|------|------|
| 低 | 高（>80%） | 静态画面+环境微动（风吹、水波）、角色微表情变化、缓慢运镜 | 直接生成 |
| 中低 | 较高（60-80%） | 角色行走、缓慢转身、简单手势、平稳推拉镜头 | 直接生成，可能需 2-3 次尝试 |
| 中 | 中等（40-60%） | 角色跑步、物体交互（拿取/放下）、快速运镜 | 降低动作幅度，简化描述 |
| 中高 | 较低（20-40%） | 多角色同时动作、复杂手部动作、快速追逐 | 拆分动作、减少同屏运动元素 |
| 高 | 低（<20%） | 打斗、超自然特效+角色同时运动、群体场景运动 | 必须降级处理 |

### 降级策略

当分镜脚本要求的运动复杂度超出 Seedance 能力时，采取以下降级策略：

**策略一：运动简化**
- 将复杂动作简化为核心动作（如"翻滚后起身出拳"→"出拳"）
- 减少同屏运动元素数量（如"三个人同时跑"→"主角跑，背景人物模糊"）
- 降低运动速度（`quickly` → `steadily` → `slowly`）

**策略二：镜头拆分**
- 如果一个镜头内有多个复杂动作阶段，进一步拆分为更短的片段（如 10s→5s+5s）
- 拆分后的片段各自只包含一个简单动作
- 需要回到 step6 为新增的分割点补生成锚点帧
- **注意**：这会增加总镜头数和总工作量，仅在运动质量无法保障时使用

**策略三：静态替代**
- 极端情况下，将运动镜头降级为"微动态静态镜头"
- 角色保持静态姿势，仅有环境微动（风吹衣衫、光影变化、粒子飘动）
- 配合 step8 的剪辑节奏（快切+音效）弥补动态感
- 适用于：超自然特效场面、大规模群战的远景镜头

**策略四：后期弥补**
- 生成相对静态的片段，在 step8 中通过后期手段增加动态感
- 可用手段：加速播放、缩放裁切模拟推拉、叠加粒子特效、音效强化
- 适用于：运镜效果无法通过 Seedance 实现的情况

---

## 连续性反馈循环

### 核心机制

step7 是连续性链的**实际执行者**。step6 只提供链头锚点帧，链内后续镜头的首帧由 step7 自己提供——从前一镜头视频的末帧提取。

```
连续性链示例: SC005-003 → SC005-004 → SC005-005 → SC005-006

step7 执行流程:

  SC005-003（链头，首帧来自 step6 锚点帧）
    → 生成视频 → 质量评估 → A 级 ✓
    → 提取视频末帧 → 保存为 SC005-003_tail.png
    ↓
  SC005-004（链内，首帧 = SC005-003_tail.png）
    → 生成视频 → 质量评估 → B 级 ✓
    → 提取视频末帧 → 保存为 SC005-004_tail.png
    ↓
  SC005-005（链内，首帧 = SC005-004_tail.png）
    → 生成视频 → 质量评估 → A 级 ✓
    → 提取视频末帧 → 保存为 SC005-005_tail.png
    ↓
  SC005-006（链尾，首帧 = SC005-005_tail.png）
    → 生成视频 → 质量评估 → B 级 ✓
    → 链条结束，无需提取尾帧
```

### 尾帧提取规则

从视频中提取尾帧时：
1. **取最后一帧**——直接从 mp4 文件中提取最后一帧作为 PNG
2. **分辨率保持一致**——提取的帧分辨率必须与 step6 锚点帧一致
3. **不做任何后处理**——提取的尾帧原样传递给下一镜头，不做调色、裁切或任何修改
4. **存储位置**——保存在 `step7-clips/{场次}/{镜号}_tail.png`

### 链条中断处理（Chain Break）

**问题**：如果连续性链中某个镜头的视频质量为 C 级（勉强可用），其尾帧画面质量差，将这个低质量尾帧传递给下一镜头作为首帧，会导致后续所有镜头的质量被"污染"——错误会沿链条累积放大。

**中断阈值**：当连续性链内某个镜头的视频质量评估满足以下任一条件时，触发链条中断：
- **角色一致性 = C**（面部在运动中变形严重，末帧已不像该角色）
- **画面稳定性 = C**（末帧存在撕裂、模糊、伪影）
- **综合评级 = C 且是链内位置靠前的镜头**（后面还有 ≥2 个链内镜头受影响）

**中断流程**：

```
连续性链: SC005-003 → SC005-004 → SC005-005 → SC005-006

  SC005-003: 生成视频 → A 级 ✓ → 提取尾帧
  SC005-004: 用尾帧作首帧 → 生成视频 → C 级 ⚠️

  ──── 触发链条中断 ────

  步骤1: 将 SC005-004 标记为"链条中断点"
         - 该视频保留（C 级，勉强可用，step8 可做后期补偿）
         - 其尾帧 NOT 传递给下一镜头

  步骤2: 尝试重新生成 SC005-004（最多按再生策略重试）
         - 如果重生后质量提升至 B 级以上 → 恢复链条，提取新尾帧继续
         - 如果重试次数耗尽仍为 C 级 → 执行步骤3

  步骤3: 请求 step6 为 SC005-005 生成新锚点帧
         - 向 step6 发起"中断回退"请求
         - step6 按正常流程为 SC005-005 生成首帧（参考分镜脚本，不参考任何前一镜头）
         - step6 在 keyframe_index.md 中添加 SC005-005 为"中断回退锚点"

  步骤4: 用新锚点帧继续生成
         SC005-005: 用 step6 新锚点帧 → 生成视频 → A 级 ✓ → 提取尾帧
         SC005-006: 用尾帧作首帧 → 生成视频 → B 级 ✓

  最终结果:
    原链被切为两段：
    链段1: SC005-003 → SC005-004（C 级中断点）
    链段2: SC005-005（新锚点）→ SC005-006
    在 clip_index.md 中标注中断信息，供 step8 做转场处理
```

**中断的后果与 step8 的处理**：
- 中断点处两个镜头之间会有画面不连续（因为 SC005-005 的首帧不再来自 SC005-004 的尾帧）
- step8 在这个切点处应使用转场效果（如叠化、短暂黑场）而非硬切，以掩盖不连续
- clip_index.md 中会标注中断点位置，供 step8 读取

### 正反打对话的处理

正反打序列中的每个镜头都有 step6 提供的独立锚点帧，不属于连续性链，因此不涉及反馈循环。但空间关系仍需一致：

```
镜头1 (A视角): 拍B说话，A的肩在前景左侧
镜头2 (B视角): 拍A说话，B的肩在前景右侧
镜头3 (A视角): 拍B反应，A的肩在前景左侧（与镜头1一致）
镜头4 (B视角): 拍A反应，B的肩在前景右侧（与镜头2一致）

策略：
  - 镜头1和镜头3使用同一组参考图和相似的 prompt
  - 镜头2和镜头4使用同一组参考图和相似的 prompt
  - 人物动作和表情不同，但空间关系和光影方向保持一致
  - 正反打镜头之间不需要尾帧提取和传递
```

---

## 工作流程

### 第一步：准备工作

1. 读取 `keyframe_index.md`，解析全部镜头的帧类型和连续性链结构
   - 建立"镜号→首帧来源"映射（step6 锚点帧路径 或 "等待前一视频尾帧"）
   - 提取全部连续性链的链头和链内顺序
2. 读取 `shot_list.md`，统计总镜头数，提取每个镜头的运镜方式和时长
3. 规划生成顺序：
   - 连续性链内镜头必须严格按链内顺序逐个生成（有依赖关系）
   - 不同连续性链之间、独立镜头之间可并行
4. 读取 `asset_index.md`，建立角色参考图查找表（供 Full Reference 模式使用）
5. 制定生成优先级

### 第二步：生成优先级规划

| 优先级 | 对象 | 说明 |
|-------|------|------|
| P0 | 连续性镜头对 | 必须按序生成，且前后验证衔接 |
| P1 | ★★★★★ 事件关键镜头 | 影片高潮，运动质量要求最高 |
| P2 | 角色特写/近景运动镜头 | 面部一致性最敏感 |
| P3 | 简单运动镜头（固定机位+微动） | 成功率高，快速推进 |
| P4 | 复杂运动镜头 | 可能需要降级处理，放到最后 |

### 第三步：逐镜头 Motion Prompt 翻译与生成

对每个镜头执行以下子流程（连续性链内镜头必须按顺序逐个执行）：

```
1. 确定首帧来源
     - keyframe_index 帧类型为"锚点" → 加载 step6 锚点帧
     - keyframe_index 帧类型为"step7提供" → 加载前一镜头的 _tail.png
     - 如有"中断回退锚点" → 加载 step6 应急锚点帧
      ↓
2. 读取分镜脚本中该镜头的"动态描述"和"运镜方式"
      ↓
3. 评估运动复杂度 → 确定是否需要降级处理
      ↓
4. 翻译运镜方式 → 部分一（Camera Motion）
      ↓
5. 翻译动态描述 → 部分二（Subject Motion）
      ↓
6. 提取音效提示 + Art Direction 风格 → 部分三（Mood & Style）
      ↓
7. 组装完整 motion prompt
      ↓
8. 确定生成模式（First Frame / Full Reference）
      ↓
9. 加载首帧图 + 参考图（视模式而定）
      ↓
10. 执行 Seedance 2.0 生成
      ↓
11. 质量评估（运动自然度、角色一致性、物理合理性、画面稳定性）
      ↓
12. 不合格 → 调整策略重新生成（见重新生成策略）
      ↓
13. 合格 → 存入 step7-clips/{场次}/{镜号}.mp4
      ↓
14. 该镜头是否属于连续性链且后面还有链内镜头？
     - 是 → 检查质量是否触发链条中断阈值
       - 未触发 → 提取视频末帧 → 保存为 {镜号}_tail.png → 传递给下一镜头
       - 触发中断 → 执行链条中断处理（见"连续性反馈循环"章节）
     - 否 → 跳过尾帧提取
      ↓
15. 记录 motion prompt 和生成参数 → {镜号}_motion.md
```

### 第四步：连续性验证

由于连续性链采用了反馈循环（前一视频尾帧 → 下一视频首帧），帧级连续性已在生成过程中内建保障。本步骤做**全链贯穿验证**：

1. 将每条连续性链的全部视频按顺序首尾相接播放
2. 检查项：
   - 链头锚点帧处：视频起始画面是否与 step6 锚点帧一致？
   - 链内衔接处：前一视频末帧→后一视频首帧是否自然过渡？（由于后者就是从前者提取的，理论上应完美衔接，但需确认 Seedance 生成时未偏离首帧）
   - 角色动作是否延续？
   - 光影方向是否一致？
   - 运动速度是否匹配？
   - 链条中断点处：两段链之间的画面不连续是否在可接受范围内？（供 step8 用转场处理）
3. 不合格的衔接点，根据问题类型决定：
   - Seedance 生成偏离首帧 → 重新生成该镜头（在 prompt 中强化首帧状态描述）
   - 光影不一致 → 重新生成（在 prompt 中强化光影描述）
   - 角色面貌变化 → 切换到 Full Reference 模式重新生成

### 第五步：编写 clip_index.md

所有视频片段生成并确认后，编写索引文件：

```markdown
# 视频片段索引

> 本文件由阶段7（视频生成）产出。
> 阶段8（剪辑后期）通过本索引按顺序加载全部视频片段。

## 统计

| 指标 | 值 |
|------|-----|
| 总片段数 | {N} |
| 总时长 | {MM:SS} |
| 平均片段时长 | {N.N}s |
| 连续性链数量 | {N} |
| 链条中断次数 | {N} |
| 降级处理片段数 | {N} |
| 重新生成次数 | {N} |

## 质量分布

| 评级 | 数量 | 占比 |
|------|------|------|
| A（优秀） | {N} | {N}% |
| B（合格） | {N} | {N}% |
| C（勉强可用） | {N} | {N}% |

## 链条中断记录

| 中断链 | 中断点镜号 | 中断原因 | 新锚点镜号 | step8 建议转场 |
|--------|-----------|---------|-----------|--------------|
| chain-01 | SC005-004 | 角色一致性=C | SC005-005 | 叠化 0.5s |
| ... | ... | ... | ... | ... |

## 索引

| 镜号 | 文件路径 | 时长 | 首帧来源 | 生成模式 | 质量评级 | 降级 | 连续性 | 备注 |
|------|---------|------|---------|---------|---------|------|--------|------|
| SC001-001 | SC001/SC001-001.mp4 | 10s | step6锚点 | First Frame | A | 否 | 独立 | — |
| SC001-002 | SC001/SC001-002.mp4 | 8s | step6锚点 | Full Reference | B | 否 | 独立 | — |
| SC005-003 | SC005/SC005-003.mp4 | 10s | step6锚点 | First Frame | A | 否 | chain-01 链头 | — |
| SC005-004 | SC005/SC005-004.mp4 | 8s | step7尾帧 | First Frame | C | 否 | chain-01 ⚠️中断点 | step8: 叠化转场 |
| SC005-005 | SC005/SC005-005.mp4 | 10s | step6中断回退 | Full Reference | A | 否 | chain-01 新锚点 | — |
| SC005-006 | SC005/SC005-006.mp4 | 8s | step7尾帧 | First Frame | B | 否 | chain-01 链尾 | — |
| SC042-007 | SC042/SC042-007.mp4 | 12s | step6锚点 | First Frame | B | 是(策略一) | 独立 | 原始动作过复杂，已简化 |
| ... | ... | ... | ... | ... | ... | ... | ... | ... |
```

### 第六步：全局质量审查

1. **角色一致性审查**：随机抽取同一角色的 10 个视频片段，检查运动过程中角色面貌是否保持一致（尤其关注快速运动时）
2. **运镜质量审查**：检查所有运镜是否与分镜设计一致（如分镜要求推镜，视频是否真的有推镜效果）
3. **连续性审查**：将全部连续性镜头对的视频首尾播放，验证衔接自然度
4. **降级片段审查**：所有标记"降级处理"的片段，审查降级后的效果是否可接受
5. **节奏预览**：按场次顺序快速播放全部片段（无转场），感受整体节奏是否合理
6. **覆盖完整性**：shot_list.md 中的每个镜头，是否都有对应的视频片段？无遗漏？

---

## 重新生成策略

当生成结果不合格时，按以下优先级调整：

| 级别 | 策略 | 适用场景 |
|------|------|---------|
| L1 | 换 seed | 运动方向大致正确但细节不理想 |
| L2 | 简化 motion prompt | 运动过于复杂导致失控——减少同时运动的元素 |
| L3 | 降低运动速度 | 快速运动导致画面撕裂/模糊——将 `quickly` 改为 `slowly` |
| L4 | 切换/组合生成模式 | 角色变脸→加 Full Reference；衔接不连续→加 First-Last Frame |
| L5 | 拆分镜头 | 多个动作阶段同时存在——拆为更短的片段各处理一个动作 |
| L6 | 静态替代 | 极端情况——降级为微动态静态镜头，后期弥补 |
| L7 | 回溯修改首帧 | 首帧构图导致运动空间不足——回到 step6 调整锚点帧 |
| L8 | 链条中断 | 连续性链内镜头质量过差——中断链条，请求 step6 为下一镜头生成新锚点帧（见"链条中断处理"） |

**重新生成上限**：单个镜头最多重新生成 5 次。超过 5 次仍不合格：
- 如果是运动复杂度问题 → 强制降级（策略五或策略六）
- 如果是一致性问题 → 检查参考图质量，可能需要回到 step4 或 step6
- 如果是连续性链内镜头且质量为 C 级 → 触发链条中断（L8），防止尾帧污染后续镜头
- 记录问题类型和最终解决方案，供后续相似镜头参考

---

## 与下游阶段的数据接口

### → 阶段8（剪辑后期）

本阶段为 step8 提供：

1. **视频片段**——按镜号命名的 mp4 文件，step8 按 `clip_index.md` 的顺序加载
2. **clip_index.md**——片段索引，包含每个片段的时长、首帧来源、质量评级、连续性关系、降级标记、链条中断标记
3. **链条中断记录**——clip_index.md 中的"链条中断记录"表，标明中断点位置和建议转场方式。step8 在中断点处应使用转场效果（叠化、短暂黑场等）而非硬切，以掩盖画面不连续
4. **降级标记**——标记为"降级处理"的片段，step8 需要通过后期手段（加速、特效、音效）弥补动态感不足
5. **质量评级**——C 级片段可能需要 step8 做额外处理（如微调色彩、裁切画面、添加特效遮盖）

**step8 的加载流程**：
```
读取 clip_index.md
    → 按镜号顺序加载 mp4 文件
    → 根据 step5 shot_list.md 的"衔接方式"添加转场
    → 链条中断点处使用 clip_index.md 建议的转场方式
    → 降级片段做后期补偿
    → C 级中断点片段做额外后期处理
    → 拼接为完整影片
```

---

## 常见错误（必须避免）

| 错误 | 后果 | 预防 |
|------|------|------|
| Motion prompt 过于复杂 | 运动失控，画面崩溃 | 先评估复杂度，高复杂度必须降级 |
| 未对角色特写/近景使用 Full Reference | 运动过程中角色"变脸" | 所有角色特写/近景必须注入肖像参考 |
| 连续性链内镜头打乱顺序生成 | 前一视频尾帧尚未提取，后一镜头无首帧可用 | 严格按链内依赖顺序逐个生成 |
| 链内 C 级视频未触发链条中断 | 低质量尾帧污染后续所有镜头 | 每个链内视频生成后立即评估质量，满足中断条件时立即中断 |
| 链条中断后未请求 step6 生成新锚点帧 | 后续镜头无首帧可用 | 中断流程第三步必须执行 step6 回退请求 |
| 提取尾帧时做了后处理（调色/裁切） | 下一镜头的首帧与实际视频不匹配 | 尾帧必须原样提取，不做任何修改 |
| 快速运动未降速 | 画面撕裂、运动模糊过重 | 宁慢勿快，后期可加速 |
| 忽略环境微动描述 | 静态背景导致画面"假"感 | prompt 中补充环境动态（风、水波、光影变化） |
| 运镜与首帧构图冲突 | 推镜时画面超出首帧可视范围 | 确认首帧构图为运镜留出足够空间 |
| 时长参数与分镜不一致 | 片段过长/过短，剪辑时对不上 | 从 shot_list.md 直接提取时长参数 |
| 多次重新生成未记录 | 后续相似镜头重复踩坑 | 每次调整记录在 generation_log.md |
| 降级片段/中断点未标记 | step8 不知道哪些片段需要后期补偿或特殊转场 | clip_index.md 中必须标注降级标记、中断点和建议转场 |
| 视频分辨率与首帧不一致 | 剪辑时画面尺寸不匹配 | Seedance 生成分辨率与首帧分辨率保持一致 |
| 正反打违反空间一致性 | 角色左右位置在镜头间跳变 | 同一对话序列的 A/B 视角使用一致的空间描述 |

## 质量标准

合格的视频片段集必须满足：

1. **全面覆盖**：shot_list.md 中的每个镜头都有对应的视频片段，无遗漏
2. **运动自然**：角色动作流畅自然，无明显抖动、穿模、漂浮
3. **角色一致**：运动过程中角色面貌保持一致，与首帧和肖像锚点匹配
4. **运镜执行**：镜头运动方式与分镜设计一致（推/拉/摇/跟/固定）
5. **物理合理**：重力、惯性、碰撞等物理效果基本合理
6. **画面稳定**：无帧间闪烁、无画面撕裂、无突然模糊
7. **连续性衔接**：连续性链内视频首尾自然衔接（基于实际尾帧传递机制）
8. **链条中断可控**：中断点数量尽可能少，中断点处的画面不连续在 step8 转场可修复的范围内
9. **时长正确**：每个片段时长在 8-15s 范围内，与分镜设计一致
10. **prompt 可追溯**：每个片段都有对应的 motion prompt 记录文件，参数完整可复现
11. **下游可用**：step8 可直接按 clip_index.md 顺序加载片段，通过链条中断记录和降级标记决定后期处理策略
