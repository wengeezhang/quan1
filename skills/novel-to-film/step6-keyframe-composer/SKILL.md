---
name: keyframe-composer
description: 为镜头生成锚点首帧图（keyframe），作为 Seedance 2.0 image-to-video 的起点。核心职责包括：从分镜脚本的导演描述翻译为 Seedream image prompt、通过 asset_index.md 查找并组装参考图、识别连续性链并仅为链头和独立镜头生成首帧（链内后续镜头的首帧由 step7 从视频实际尾帧提取）、执行生成并验证一致性。
---

# 首帧合成

## 定位

首帧合成是整条流水线中**画面质量的决定性环节**。

Seedance 2.0 的 image-to-video 模式以一张静态图片为起点，生成 8-15 秒的视频片段。这意味着：**首帧图的质量直接决定了视频片段的质量上限**——角色长相、构图、光影、氛围，全部由首帧锁定。视频生成只是在首帧基础上"让画面动起来"，它不会修正首帧中的错误。

在好莱坞制作流程中，本阶段对应 **Layout / Pre-lighting** 阶段——在正式"拍摄"（视频生成）之前，为每个镜头精确设定画面构图、角色位置、光影方案。区别在于：传统流程中这一步的产出是 3D 预览或灯光测试图；AI 制作流中，这一步的产出就是最终画面的起始帧——它同时承担了"预览"和"定稿"的双重角色。

**本阶段的核心职责之一是 prompt 工程**。step5 的分镜脚本以导演语言（中文叙事）描述画面意图，但 Seedream 需要的是结构化的英文图片生成提示词。本阶段负责将"导演想要什么"翻译成"Seedream 应该生成什么"——这个翻译过程不是简单的中译英，而是涉及冻结时刻选择、参考图权重调配、负面提示词补充等一系列技术决策。**所有 prompt 必须中英双语输出**——英文版用于 Seedream 生成，中文版（英文版的直译）用于人工审核和导演确认。

## 核心原则

1. **首帧即定稿**——首帧图不是"草稿"或"预览"，它就是最终视频的第一帧。角色面貌、构图、光影、色彩在首帧中必须达到最终品质
2. **一致性压倒一切**——同一角色在第 1 个镜头和第 200 个镜头中必须长得一样。一致性通过三重机制保障：肖像锚点（`_portrait/`）→ 阶段参考图（`{stage_id}/`）→ prompt 中的角色描述一致
3. **prompt 是桥梁**——本阶段的核心技术能力是将 step5 的导演意图准确翻译为 Seedream 可执行的 image prompt，同时注入全局风格前缀和参考图约束
4. **锚点帧思维**——step6 只为连续性链的**第一个镜头**和所有**独立镜头**生成首帧（称为"锚点帧"）。连续性链内部后续镜头的首帧由 step7 从前一镜头视频的实际尾帧提取，确保连续性基于真实画面而非想象画面
5. **参考图是锚**——每个包含角色的镜头，都必须将该角色的肖像（`_portrait/`）和阶段参考图（`{stage_id}/`）作为 Seedream 的参考输入。没有参考图的角色镜头 = 失控的一致性

## 输入

- `production/step5-storyboard/storyboard/{SC{NNN}}.md`——分镜脚本（逐镜头的画面描述、元素标注、连续性需求、参考图建议）
- `production/step5-storyboard/shot_list.md`——镜头表（景别、机位、运镜、时长的快速总览）
- `production/step5-storyboard/event-previs/`——事件预可视化概念图（复杂场面的视觉锚点）
- `production/step4-assets/asset_index.md`——资产索引（stage_id → 参考图路径）
- `production/step4-assets/`——视觉资产库（实际参考图文件）
- `production/step2-art-direction/art_direction.md`——全局视觉风格定义（全局 style prompt 前缀）

**研究方法**：
1. 先读 `art_direction.md` 第七章，提取全局 style prompt 前缀——这是所有 prompt 的固定开头
2. 读 `asset_index.md`，建立"角色+stage_id → 参考图路径"的快速查找索引
3. 读 `shot_list.md`，统计总镜头数，识别需要连续性处理的镜头对
4. 按场次顺序读取分镜脚本，逐镜头执行 prompt 翻译和生成

## 输出

`production/step6-keyframes/` 下的锚点首帧图集和生成日志：

```
production/step6-keyframes/
├── SC001/
│   ├── SC001-001_first.png          # 锚点帧（连续性链 A 的链头）
│   ├── SC001-001_prompt.md          # 该镜头的完整 prompt 记录
│   ├── SC001-005_first.png          # 锚点帧（独立镜头）
│   ├── SC001-005_prompt.md
│   ├── SC001-008_first.png          # 锚点帧（连续性链 B 的链头）
│   ├── SC001-008_prompt.md
│   └── ...                          # 注意：SC001-002~004 等链内镜头无首帧文件
├── SC002/
│   └── ...
├── ...
├── keyframe_index.md                # 锚点帧索引（镜号 → 文件路径 → 连续性链角色）
└── generation_log.md                # 生成日志（记录每次生成的参数和结果）
```

**重要**：step6 不再为所有镜头生成首帧。连续性链内部后续镜头的首帧由 step7 从前一镜头视频的实际尾帧提取。step6 仅生成：
- 每条连续性链的**第一个镜头**的首帧（锚点帧）
- 所有**独立镜头**（无连续性需求）的首帧
- step7 **链条中断回退**时请求的应急锚点帧（见 step7 链条中断处理）

**文件命名规则**：
- 锚点首帧：`{镜号}_first.png`
- Prompt 记录：`{镜号}_prompt.md`
- 按场次分子目录，目录名 = 场次编号

---

## Prompt 工程：从导演意图到生成指令

这是本阶段的核心技术环节。每个镜头的 Seedream prompt 由四个层次组装而成：

### 层次一：全局风格前缀（Global Style Prefix）

来源：`art_direction.md` 第七章。

这是所有 prompt 的固定开头，锁定全片画风统一。示例：

```
cinematic, dark fantasy, muted earth tones with amber highlights,
dramatic chiaroscuro lighting, subtle film grain, 2.39:1 anamorphic,
photorealistic rendering, atmospheric haze
```

**规则**：全局前缀在全片所有镜头中保持不变，不可逐镜头修改。

### 层次二：镜头技术参数（Shot Specification）

来源：step5 镜头表的景别、机位、运镜信息。

将中文镜头术语翻译为 Seedream 识别的英文术语：

| step5 中文 | Prompt 英文 | 说明 |
|-----------|------------|------|
| 大远景 | `extreme wide shot` | 环境为主 |
| 远景 | `wide shot` | 人物可辨 |
| 全景 | `full shot` | 人物全身 |
| 中景 | `medium shot` | 膝部以上 |
| 中近景 | `medium close-up` | 胸部以上 |
| 近景 | `close-up` | 肩部以上 |
| 特写 | `close-up` | 面部/物体 |
| 大特写 | `extreme close-up` | 局部 |
| 平视 | `eye-level angle` | — |
| 俯视 | `high angle` | — |
| 仰视 | `low angle` | — |
| 鸟瞰 | `bird's eye view` / `aerial view` | — |
| 荷兰角 | `dutch angle` / `tilted frame` | — |
| 过肩 | `over-the-shoulder shot` | — |

### 层次三：画面内容（Visual Content）

来源：step5 分镜脚本的"画面描述"段落。

这是翻译工作量最大的部分。需要将中文叙事描述转化为 Seedream 的结构化英文描述，遵循以下子结构：

```
[主体] + [动作/姿态] + [服装/道具] + [环境] + [光影] + [氛围]
```

**翻译规则**：

1. **角色描述不用真名**——使用通用描述（如 `a sturdy Chinese man in his 30s`），真名只在元素标注中用于查找参考图
2. **冻结时刻**——从分镜的"动态描述"中提取第 0 秒的状态作为首帧画面。如果分镜的动态描述是"0-3s：角色站在码头边一动不动；3-7s：缓缓转身"，那首帧应该是"角色站在码头边一动不动"的画面
3. **空间层次明确**——前景（foreground）、中景（midground）、背景（background）必须分别描述
4. **光影具体化**——"氛围感的光影"不够，需要写成 `golden hour side lighting from the left, long shadows stretching right, warm rim light on the character's silhouette`
5. **色彩具体化**——尽可能使用具体色彩词而非抽象描述（`deep burgundy robe` 而非 `dark robe`）

**翻译示例**：

```
step5 画面描述（中文）:
  "画面前景是朱围庸的背影，他身着深色长衫站在破旧码头边缘，
   海风吹起衫角。中景是空旷的海面，远景是灰蒙蒙的天际线。
   光源从画面左侧低角度打入（黄昏侧光），长影子向右延伸。
   视觉焦点在朱围庸微微低垂的头部轮廓。"

      ↓ 翻译

Prompt 层次三:
  a sturdy Chinese man seen from behind, wearing a dark indigo
  long robe, standing at the edge of a weathered wooden dock,
  wind lifting the hem of his robe, head slightly bowed;
  midground: calm empty sea stretching to the horizon;
  background: hazy overcast skyline;
  golden hour side lighting from the left casting long shadows
  to the right, warm rim light outlining the man's silhouette;
  melancholic solitary atmosphere
```

### 层次四：负面提示词（Negative Prompt）

来源：根据画面需求自行补充，step5 中不包含此信息。

负面提示词排除不需要的视觉元素，防止 Seedream 生成偏差：

**全局负面提示词**（所有镜头通用）：
```
negative: modern elements, anachronistic objects, bright neon colors,
anime style, cartoon, watermark, text overlay, blurry, low quality,
distorted faces, extra limbs, deformed hands
```

**场景特定负面提示词**（根据具体镜头补充）：
```
# 古代场景
negative: modern buildings, cars, power lines, concrete

# 夜景
negative: bright daylight, blue sky, harsh shadows

# 单人镜头
negative: multiple people, crowd, extra figures

# 特写镜头
negative: full body visible, wide landscape, distant view
```

### Prompt 组装流程

每个镜头的完整 prompt 按以下顺序组装：

```
[层次一：全局风格前缀]
[层次二：景别 + 机位角度]
[层次三：画面内容（主体 + 动作 + 服装 + 环境 + 光影 + 氛围）]

Negative: [全局负面] + [场景特定负面]

Reference images:
  - 角色肖像锚点: {_portrait/正面半身像.png} (consistency anchor)
  - 角色阶段参考: {stage_id/*.png} (appearance reference, weight: {W})
  - 场景参考: {stage_id/*.png} (environment reference, weight: {W})
```

### Prompt 记录文件格式

每个镜头生成一份 `{镜号}_prompt.md`，记录完整的生成参数：

```markdown
# Prompt Record: {镜号}

## 来源

- 分镜脚本：storyboard/{SC{NNN}}.md → 镜头 {镜号}
- 章节：ch{X}

## 完整 Prompt

### Positive (English)
\```
{层次一 + 层次二 + 层次三 的完整组装（英文）}
\```

### Positive (中文)
\```
{上述英文 Positive prompt 的中文直译}
\```

### Negative (English)
\```
{全局负面 + 场景特定负面（英文）}
\```

### Negative (中文)
\```
{上述英文 Negative prompt 的中文直译}
\```

## 参考图

| 用途 | 文件路径 | 权重 | 说明 |
|------|---------|------|------|
| 角色一致性锚点 | characters/朱围庸/_portrait/正面半身像.png | 0.5 | 面部基线 |
| 角色阶段参考 | characters/朱围庸/占身乞丐期/*.png | 0.7 | 服装+整体形象 |
| 场景参考 | locations/恶灵区/默认/*.png | 0.4 | 环境氛围 |

## 生成参数

| 参数 | 值 |
|------|-----|
| 图片类型 | 锚点帧 |
| 分辨率 | {W}x{H} |
| Seed | {seed} |
| 生成批次 | {N} 张候选 |
| 选中 | 第 {N} 张 |
| 选中原因 | {一致性最高 / 构图最佳 / ...} |

## 质量评估

| 维度 | 评分 | 说明 |
|------|------|------|
| 角色一致性 | {A/B/C} | {与肖像锚点对比} |
| 构图匹配 | {A/B/C} | {与分镜描述对比} |
| 光影氛围 | {A/B/C} | {与 Art Direction 对比} |
| 细节正确 | {A/B/C} | {服装、道具、环境} |
```

---

## 参考图策略

### 参考图权重指南

参考图权重决定了 Seedream 生成结果对参考图的依赖程度。权重过高会导致画面僵硬（角色姿态被锁死），权重过低会丢失一致性（角色"变脸"）。

| 景别 | 角色肖像锚点权重 | 角色阶段参考权重 | 场景参考权重 | 说明 |
|------|----------------|----------------|------------|------|
| 特写/大特写 | 0.6-0.7 | 0.7-0.8 | 0.2-0.3 | 面部细节最重要 |
| 近景/中近景 | 0.5-0.6 | 0.6-0.7 | 0.3-0.4 | 面部+上身 |
| 中景 | 0.4-0.5 | 0.5-0.6 | 0.4-0.5 | 平衡人物和环境 |
| 全景 | 0.3-0.4 | 0.4-0.5 | 0.5-0.6 | 环境比重增大 |
| 远景/大远景 | 0.2-0.3 | 0.2-0.3 | 0.6-0.7 | 环境为主 |

### 多角色镜头的参考图策略

当一个镜头中出现多个角色时，参考图输入需要分层处理：

**主视角角色**（画面焦点）：
- 使用较高的参考图权重（按上表）
- 同时输入肖像锚点和阶段参考图

**次要角色**（画面中可见但非焦点）：
- 降低参考图权重（比主视角角色低 0.1-0.2）
- 仅输入阶段参考图，省略肖像锚点

**背景角色**（画面中远处可见）：
- 不单独输入参考图
- 在 prompt 中用通用描述（`several figures in the background`）

**超过 3 个角色的群戏镜头**：
- Seedream 的参考图输入通道有限，不可能为每个角色都输入参考图
- 策略：只为前 2-3 个最重要的角色输入参考图，其余用 prompt 描述
- 利用事件预可视化（5a）的概念图作为整体构图参考

### 道具参考图

- 画面中明显可见的道具（如角色手持泉水瓶）：输入道具参考图，权重 0.3-0.4
- 画面中不明显的道具：在 prompt 中描述即可，无需参考图
- 超自然道具（有光效的）：输入参考图 + 在 prompt 中强调光效描述

---

## 连续性规划（锚点帧模式）

### 架构原则

step6 采用**锚点帧模式**：不为所有镜头生成首帧，只为连续性链的**链头**和**独立镜头**生成首帧。连续性链内部后续镜头的首帧由 step7 从前一镜头视频的实际尾帧提取。

这个设计基于一个关键洞察：step6 如果为连续性镜头"想象"尾帧，本质上是在预测视频生成结果——但 step7 实际生成的视频末帧未必与想象一致，导致连续性保障是虚的。用 step7 的真实视频尾帧作为下一镜头的首帧，连续性基于真实画面，可靠性质变提升。

### 连续性链识别

扫描分镜脚本的"首帧合成提示"段落，将全部镜头分为三类：

| 镜头类型 | 定义 | step6 是否生成首帧 |
|---------|------|-------------------|
| **链头镜头** | 连续性链的第一个镜头（前面无连续性前接镜头） | ✅ 生成锚点帧 |
| **链内镜头** | 连续性链内部的后续镜头（前面有连续性前接镜头） | ❌ 首帧由 step7 提供 |
| **独立镜头** | 无任何连续性需求的镜头 | ✅ 生成锚点帧 |

**连续性链的场景类型**：

| 场景 | 说明 | 链头 | 链内 |
|------|------|------|------|
| 动作衔接 | 前镜头的动作在后镜头延续 | 第一个镜头 | 后续镜头 |
| 同一动作多镜头拆分 | 15s 超时被拆为 2-3 个镜头 | 第一段 | 后续段 |
| 环绕镜头拆分 | 360°环绕被拆为多段 | 第一段 | 后续段 |

**独立镜头的场景类型**：

| 场景 | 说明 |
|------|------|
| 场次切换 | 不同时空，无需连续 |
| 硬切 | 导演意图的视觉跳跃 |
| 叠化/淡入淡出 | 转场效果在阶段8处理 |
| 独立插入镜头 | 空镜头、闪回 |

### 正反打对话的特殊处理

正反打（shot/reverse shot）是特殊情况：它有空间一致性需求，但各镜头之间**不是**严格的帧级连续性链（A 视角切 B 视角时画面本身是不连续的）。

处理方式：**正反打序列中的每个镜头都由 step6 生成首帧**（都是独立锚点），但必须保持空间一致性：

```
步骤1: 生成建立镜头（establishing shot）的首帧
  - 通常是双人中景，确定两个角色的空间关系
步骤2: 从建立镜头中推导 A→B 和 B→A 的视角
  - A 视角的过肩镜头：前景是 A 的肩部（模糊），焦点是 B
  - B 视角的过肩镜头：前景是 B 的肩部（模糊），焦点是 A
步骤3: 分别生成各镜头首帧
  - 保持两个角色的空间位置关系不变（左右不翻转）
  - 保持光影方向一致（不能一个镜头从左打光、另一个从右打光）
步骤4: 验证180度规则
  - 正反打的所有镜头必须在180度线的同一侧
  - 违反180度规则会导致观众产生空间混乱
```

### step7 链条中断回退机制

当 step7 在生成连续性链时发现某个镜头的视频质量过差（C 级），其尾帧会污染后续所有镜头。此时 step7 会发起**链条中断回退**，请求 step6 为中断点之后的下一个镜头生成一个新的锚点帧。

**step6 的响应流程**：
1. step7 标记中断点镜号和下一个需要锚点帧的镜号
2. step6 为该镜号按正常流程生成首帧（参考分镜脚本，不参考任何前一镜头的尾帧）
3. 生成完毕后通知 step7 继续生成
4. 在 `keyframe_index.md` 中标注该帧为"中断回退锚点帧"

**示例**：
```
原始连续性链: SC005-003 → SC005-004 → SC005-005 → SC005-006
step6 初始生成: 仅 SC005-003 锚点帧

step7 执行:
  SC005-003: 生成视频 → A 级 → 提取尾帧 → 传递给 SC005-004
  SC005-004: 用尾帧作首帧 → 生成视频 → C 级 ⚠️ 质量过差！

  → 链条中断！SC005-004 尾帧不可信赖
  → step7 请求 step6 为 SC005-005 生成新锚点帧

step6 响应:
  为 SC005-005 生成新锚点帧（按正常流程，不参考 SC005-004）

step7 继续:
  SC005-005: 用 step6 新锚点帧 → 生成视频 → A 级 → 提取尾帧
  SC005-006: 用尾帧作首帧 → 生成视频 → B 级 ✓

最终: 原链被切为两段
  链段1: SC005-003 → SC005-004（C 级，但已是最佳结果）
  链段2: SC005-005 → SC005-006（新锚点，质量恢复）
```

---

## 工作流程

### 第一步：准备工作

1. 读取 `art_direction.md` 第七章，提取全局 style prompt 前缀
2. 读取 `asset_index.md`，建立参考图快速查找表
3. 读取 `shot_list.md`，统计总镜头数
4. 扫描全部分镜脚本的"首帧合成提示"段落，**识别连续性链并分类全部镜头**：
   - **连续性链识别**：将具有前后连续性关系的镜头串联成链
   - **链头标记**：每条连续性链的第一个镜头→ step6 需生成锚点帧
   - **链内标记**：链中后续镜头 → step6 跳过，由 step7 提供首帧
   - **独立镜头标记**：无连续性需求 → step6 需生成锚点帧
   - **正反打序列标记**：每个镜头都由 step6 生成（空间一致性，非帧级连续）
   - 统计：step6 需生成的锚点帧总数（应显著少于总镜头数）
5. 制定生成顺序和优先级

### 第二步：生成优先级规划

| 优先级 | 对象 | 说明 |
|-------|------|------|
| P0 | ★★★★★ 事件相关镜头 | 影片高潮，质量要求最高 |
| P1 | 连续性镜头对 | 必须成组生成，不可拆开 |
| P2 | 主角特写/近景镜头 | 角色一致性最敏感 |
| P3 | 场景建立镜头（每个场次的第一个镜头） | 确定场次的视觉基调 |
| P4 | 其余镜头 | 按场次顺序 |

### 第三步：逐镜头 Prompt 翻译与生成

**仅对需要生成锚点帧的镜头执行**（链头镜头 + 独立镜头 + 正反打镜头）。链内镜头跳过。

对每个需要生成的镜头执行以下子流程：

```
0. 检查该镜头是否为链内镜头 → 是 → 跳过（由 step7 提供首帧）
      ↓
1. 读取分镜脚本中该镜头的完整描述
      ↓
2. 提取"画面描述"段落 → 翻译为英文画面内容（层次三）
      ↓
3. 提取"动态描述"段落 → 确定首帧的冻结时刻（第 0 秒状态）
      ↓
4. 提取景别、机位 → 翻译为英文术语（层次二）
      ↓
5. 组装完整 prompt: 层次一 + 层次二 + 层次三 + Negative
      ↓
6. 读取"元素标注"→ 通过 asset_index.md 查找参考图路径
      ↓
7. 根据景别选择参考图权重
      ↓
8. 执行 Seedream 生成（3-5 张候选）
      ↓
9. 候选筛选：一致性评估 + 构图匹配 + 光影氛围
      ↓
10. 选中最佳 → 存入 step6-keyframes/{场次}/{镜号}_first.png
      ↓
11. 记录 prompt 和生成参数 → {镜号}_prompt.md
```

### 第四步：正反打空间一致性验证

正反打序列中的每个镜头都由 step6 独立生成，但空间关系必须一致。验证：

1. 将同一正反打序列的全部首帧并排展示
2. 检查项：
   - 两个角色的左右位置关系是否一致？（不能一个镜头 A 在左，另一个镜头 A 在右）
   - 光影方向是否一致？
   - 背景环境是否一致？
   - 180度规则是否遵守？
3. 不合格的镜头标记重新生成

**注意**：连续性链内镜头之间的帧级衔接验证由 step7 负责，因为链内后续镜头的首帧由 step7 提供。

### 第五步：编写 keyframe_index.md

所有锚点帧生成并确认后，编写索引文件：

```markdown
# 锚点帧索引

> 本文件由阶段6（首帧合成）产出。
> 阶段7（视频生成）通过本索引确定：哪些镜头有 step6 提供的锚点帧，哪些镜头需要从前一视频提取首帧。

## 统计

| 指标 | 值 |
|------|-----|
| 总镜头数 | {N} |
| step6 锚点帧数 | {N}（< 总镜头数） |
| 连续性链数量 | {N} |
| 连续性链内镜头数（step7 提供首帧） | {N} |
| 独立镜头数 | {N} |
| 正反打序列组数 | {N} |

## 连续性链清单

| 链 ID | 链头镜号 | 链内镜号 | 长度 |
|-------|---------|---------|------|
| chain-01 | SC005-003 | SC005-004, SC005-005, SC005-006 | 4 |
| chain-02 | SC012-007 | SC012-008 | 2 |
| ... | ... | ... | ... |

## 镜头索引

| 镜号 | 帧类型 | 锚点帧路径 | 连续性链 | 链内位置 | 备注 |
|------|--------|-----------|---------|---------|------|
| SC001-001 | 独立锚点 | SC001/SC001-001_first.png | — | — | — |
| SC001-002 | 独立锚点 | SC001/SC001-002_first.png | — | — | — |
| SC005-003 | 链头锚点 | SC005/SC005-003_first.png | chain-01 | 1/4 | — |
| SC005-004 | step7提供 | — | chain-01 | 2/4 | 首帧来自 SC005-003 视频尾帧 |
| SC005-005 | step7提供 | — | chain-01 | 3/4 | 首帧来自 SC005-004 视频尾帧 |
| SC005-006 | step7提供 | — | chain-01 | 4/4 | 首帧来自 SC005-005 视频尾帧 |
| SC008-001 | 正反打锚点 | SC008/SC008-001_first.png | — | — | 正反打组-01 |
| ... | ... | ... | ... | ... | ... |
```

**帧类型说明**：
- `独立锚点`：无连续性需求，step6 正常生成
- `链头锚点`：连续性链的第一个镜头，step6 正常生成
- `step7提供`：连续性链内部镜头，首帧由 step7 从前一视频尾帧提取
- `正反打锚点`：正反打序列中的镜头，step6 独立生成但保持空间一致性
- `中断回退锚点`：step7 链条中断后由 step6 应急生成（初始索引中不存在，仅在 step7 回退时动态添加）

### 第六步：全局一致性审查

1. **角色跨场次一致性**：从全片中随机抽取同一角色的 10 个锚点帧，并排对比面貌是否一致
2. **场景跨镜头一致性**：同一场次内的多个锚点帧，场景空间结构是否一致（建筑位置、光影方向不能镜头间变化）
3. **画风全局一致性**：全片锚点帧的整体画风是否统一？有无明显的风格跳跃？
4. **锚点帧完整性**：所有链头镜头、独立镜头、正反打镜头是否都有对应的锚点帧？keyframe_index 中的帧类型标注是否正确？
5. **链内镜头确认**：keyframe_index 中标记为"step7提供"的镜头，是否确实属于某条连续性链的内部？有无遗漏标记或错误标记？
6. **正反打空间一致**：每组正反打序列内的锚点帧，空间关系和光影方向是否一致？

---

## 一致性保障机制

### 角色一致性的三层保障

```
第一层：肖像锚点（_portrait/正面半身像.png）
  → 锁定面部基线——五官比例、脸型、肤色
  → 所有该角色的镜头都以此为一致性参考

第二层：阶段参考图（{stage_id}/*.png）
  → 锁定该阶段的整体形象——服装、发型、体态
  → 同一阶段内的镜头共享同一组参考图

第三层：Prompt 中的角色描述
  → 文字层面的一致性约束
  → 同一角色在所有镜头中使用相同的基础描述
    （如 "a sturdy Chinese man in his 30s, square jaw, thick eyebrows"）
  → 不同镜头只变化动作、表情、环境，不变化基础描述
```

### 角色描述模板

为每个重要角色建立一个固定的 prompt 描述模板，在所有镜头中复用：

```markdown
## 角色 Prompt 模板

### 朱围庸（占身乞丐期）
基础描述: a sturdy Chinese man in his 30s, square jaw, thick
eyebrows, weathered skin, short messy hair, wearing a dark
indigo long robe with cloth belt
默认表情: calm but watchful eyes, slight frown
体态: broad shoulders, solid build, slightly hunched posture

### 宋小仙（追魂使期）
基础描述: a slender Chinese woman in her mid-20s, sharp
almond eyes, high cheekbones, long straight black hair tied
in a low ponytail, wearing a fitted dark grey tunic
默认表情: cold composed expression, penetrating gaze
体态: upright posture, graceful but alert bearing
```

模板从角色圣经第三章（外貌与形态）和第九章A板块（肖像提示词）中提炼。**同一角色、同一阶段的基础描述在全片所有镜头中保持一字不差**——只在具体镜头中添加该镜头特有的动作、表情、环境描述。

---

## 重新生成策略

当生成结果不合格时，按以下优先级调整：

| 级别 | 策略 | 适用场景 |
|------|------|---------|
| L1 | 换 seed | 构图大致正确但细节不理想 |
| L2 | 微调 prompt 权重 | 某个元素（如面部）需要加强 |
| L3 | 增加负面提示词 | 出现了不需要的元素（如多余人物、现代物品） |
| L4 | 调整参考图权重 | 面貌偏差大→提高权重；姿态僵硬→降低权重 |
| L5 | 改写 prompt 内容 | 多次尝试仍不理想，可能是描述本身有歧义 |
| L6 | 回溯修改参考图 | 参考图本身有问题（罕见，需回到阶段4） |

**生成日志原则**：每次重新生成都必须记录在 `generation_log.md` 中，包含：调整了什么、为什么调整、调整后的结果。这些记录对后续相似镜头的生成有参考价值。

---

## 常见错误（必须避免）

| 错误 | 后果 | 预防 |
|------|------|------|
| 未使用全局 style prompt 前缀 | 画风不统一，与其他镜头风格割裂 | 每个 prompt 开头校验前缀是否存在 |
| 参考图路径通过 stage_id 查找时字面不一致 | 查找到错误的参考图或查找失败 | 从 asset_index.md 复制粘贴路径，不手打 |
| 角色描述在不同镜头间不一致 | 同一角色在不同镜头中外貌漂移 | 使用固定的角色 prompt 模板 |
| 忽略冻结时刻，将动态描述直接写入 prompt | 首帧包含了运动模糊或多个时刻的叠加 | 明确提取"第 0 秒"状态 |
| 为链内镜头生成了首帧 | 浪费生成资源，且与 step7 实际尾帧不一致 | 检查 keyframe_index，链内镜头必须跳过 |
| 正反打违反180度规则 | 观众空间混乱 | 建立基准构图后所有镜头在同侧 |
| 特写镜头参考图权重过低 | 面部一致性丢失 | 按景别权重指南设置 |
| 远景镜头参考图权重过高 | 角色姿态僵硬、画面不自然 | 远景降低角色参考权重 |
| 未记录生成参数 | 后续相似镜头无法参考，重新生成时无法复现 | 每个镜头都写 prompt 记录文件 |
| 多角色镜头为所有角色设最高权重 | Seedream 参考图冲突，生成质量下降 | 只为前 2-3 个角色设参考图，其余用 prompt |
| 首帧图分辨率不一致 | 阶段7视频生成时画面质量参差不齐 | 全片统一分辨率 |
| 未校验 prompt 英文质量 | 语法错误或歧义导致 Seedream 误解意图 | 翻译后通读一遍英文 prompt |

## 质量标准

合格的首帧图集必须满足：

1. **锚点帧完整覆盖**：所有链头镜头、独立镜头、正反打镜头都有对应的锚点帧，无遗漏
2. **链内镜头正确跳过**：连续性链内部镜头（帧类型为"step7提供"）不应有 step6 生成的首帧文件
3. **角色一致**：同一角色在全片所有锚点帧中面貌一致，与肖像锚点匹配
4. **构图匹配**：锚点帧的构图（景别、角度、人物位置）与分镜描述一致
5. **光影正确**：光源方向、色温、明暗对比符合分镜描述和 Art Direction 规范
6. **风格统一**：全片锚点帧画风一致，无明显风格跳跃
7. **正反打空间一致**：同一正反打序列内的锚点帧空间关系和180度规则正确
8. **prompt 可追溯**：每个锚点帧都有对应的 prompt 记录文件，参数完整可复现
9. **分辨率统一**：全片锚点帧使用同一分辨率
10. **下游可用**：step7 可通过 keyframe_index.md 快速确定每个镜头的首帧来源（step6 锚点帧 or step7 前一视频尾帧），连续性链关系清晰完整
