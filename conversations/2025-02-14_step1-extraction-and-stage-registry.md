# 2025-02-14 Session: Step1 元素提取执行 & Stage Registry 机制设计

## 概要

本次会话完成了两项关键工作：
1. **执行 step1-film-elements-extractor**——通读全部71章，产出7个结构化元素清单文件
2. **设计 Stage Registry（阶段注册表）机制**——解决圣经→资产→分镜→首帧全流程的阶段名精准匹配问题

---

## 一、Step1 元素提取执行

### 工作过程

按照 `step1-film-elements-extractor/SKILL.md` 定义的八步工作流程，对71章小说进行了全量扫描：

1. **第一步：快速通读**——读取全部71个 `*_summary_simple.md`，建立五个Part的全局认知
2. **第二步：角色提取**——读取全部71个 `*_character.md`，按Part分批并行读取
3. **第三步～第七步**：基于全局认知，提取场景、道具、事件、世界观、时间线
4. **第八步：覆盖率验证**——生成验证报告

### 产出文件

所有文件存放在 `production/step1-extraction/`：

| 文件 | 内容 | 条目数 |
|------|------|--------|
| characters.md | 角色清单（主角3+配角29+群像22） | 54个角色 |
| locations.md | 场景/地点清单（主要10+次要16+一次性10） | 36个场景 |
| props.md | 关键道具清单 | 17件道具 |
| events.md | 关键事件清单（★★★★★有20个） | 46个事件 |
| world_settings.md | 世界观设定（视觉规则、阵营对立、超自然体系、空间体系） | 4大分类 |
| timeline.md | 故事时间线（关联视觉变化节点） | 50+节点 |
| coverage_report.md | 覆盖率验证报告（100%覆盖） | — |

### 关键发现

- **小说结构**：Part 1 (ch1-8), Part 2 (ch9-24), Part 3 (ch25-34), Part 4 (ch35-56), Part 5 (ch57-71)
- **三大主角**：朱围庸（恶灵首领）、吴文顶/小顶（义弟/抵抗军核心）、宋小仙（追魂使/天界使者）
- **核心超自然体系**：移魂夺魄（灵魂附身）、泉水（治愈/维持生命）、数字人（科技造体）
- **待确认项**：宋小仙性别模糊、部分场景/道具缺乏原文视觉描写需原创设计

---

## 二、Location Writing Bible SKILL.md 编写

### 设计理念

从专业电影场景大师角度，设计了八章制场景圣经结构（对比角色圣经九章制）：

1. **基本信息** — 场景档案卡
2. **阶段注册表** — stage_id 定义（后加入）
3. **空间结构与地理** — ASCII平面图、纵深层次、建筑/地形、出入口、视觉锚点
4. **光影与氛围** — 主光源(色温K值)、辅助光源、阴影特征、色彩基调(HEX)、氛围参数、情绪映射
5. **声景与感官** — 环境底噪、标志性声音、触觉/温度/嗅觉
6. **场景演变轨迹** — 五维度：空间状态、光影偏移、人口活动、情绪基调、季节天气
7. **镜头预案** — 建议机位、标志性构图、运镜方案、转场建议
8. **AI绘图提示词** — 按stage_id组织，含基础概念图+阶段变化图+关键事件图+氛围板

另设计了四类特殊场景处理指南：超自然场景、复合场景、战争场景、过渡性场景。

---

## 三、Stage Registry 机制设计（核心创新）

### 问题发现

用户指出一个关键的流水线一致性问题：

> 1. SKILL.md line 137 对视觉资产的组织方式（按"阶段"建文件夹）描述很清晰，但要实现这种组织，必须在各 element bible 中提前对各阶段做输出
> 2. 当前 element bible 的 AI绘图提示词部分，仅指出需要列出各阶段描述，但没有强调阶段的准确映射——即使只差一个字，也可能导致无法精准匹配

**本质问题**：step4 资产目录用"阶段名"做文件夹名/索引键，但 step3 圣经中阶段名是分散在各章节中随手写的，没有统一注册机制。"灵魂期"和"灵魂形态期"差两个字就导致整个下游匹配断裂。

### 解决方案

在每个元素圣经中新增 **第二章：阶段注册表（Stage Registry）**：

```markdown
## 二、阶段注册表

| stage_id | 阶段描述 | 章节范围 | 视觉变化摘要 |
|----------|---------|---------|------------|
| 灵魂期 | 恶灵区中的灵魂光团形态 | ch3 | 紫色不规则光团，无实体 |
| 占身丁路期 | 附身导游丁路 | ch4-6 | 20多岁健康男性，面色苍白 |
| 占身乞丐期 | 附身乞丐，长期主要形态 | ch8-71 | 30岁壮实男性，后期深色长衫 |
```

### 核心设计原则

- **stage_id 是单一真相源（Single Source of Truth）**：贯穿 step3→4→5→6
- **全流程映射关系**：
  ```
  圣经注册表 stage_id
      = step4 资产目录文件夹名（如 characters/朱围庸/灵魂期/）
      = asset_index.md 索引键
      = step5 分镜脚本角色/场景标注
      = step6 首帧合成参考图查找键
  ```
- **命名规则**：2-6字中文短语，不含标点/空格/特殊字符（因要做文件夹名）
- **不可变性**：一旦注册，全流程禁止修改
- **圣经内部强制引用**：后续所有章节的阶段标题必须严格使用 `#### {stage_id}（ch{X}-{Y}）` 格式
- **提示词数量约束**：AI绘图提示词数量必须与注册表行数一一对应

### 修改涉及的文件

| 文件 | 修改内容 |
|------|---------|
| character-writing-bible/SKILL.md | 八章制→九章制（插入第二章阶段注册表）；所有后续章节引用阶段处增加 stage_id 强制约束；增加 Art Direction 输入引用 |
| location-writing-bible/SKILL.md | 七章制→八章制（插入第二章阶段注册表）；同上 |
| skills/novel-to-film/SKILL.md | step3 关键约束增加 Stage Registry 说明；step4 资产组织描述强化 stage_id 作为全流程映射键 |

---

## 四、数据流示意

```
step1-extraction (locations.md)
    ↓ 场景名 + 章节范围 + 氛围关键词
step2-art-direction (art_direction.md)
    ↓ 全局色彩体系 + style prompt 前缀
step3-bibles (各场景圣经)
    ├── 第二章：阶段注册表 → 定义 stage_id（单一真相源）
    ├── 第三~七章：使用 stage_id 组织内容
    └── 第八章：AI提示词（按 stage_id 一一对应）
         ↓ stage_id + AI提示词
step4-assets
    ├── locations/{场景名}/{stage_id}/*.png  ← 文件夹名 = stage_id
    └── asset_index.md  ← 索引键 = stage_id
         ↓
step5-storyboard
    └── 每个镜头标注：场景名（阶段：{stage_id}）
         ↓
step6-keyframes
    └── 查 asset_index.md：场景名 + stage_id → 找到参考图
```

---

## 五、待办事项

- [ ] 提交本次所有更改（step1-extraction 产出 + location-writing-bible + stage registry 更新）
- [ ] 编写其他 element bible SKILL.md（prop、world、event）
- [ ] 编写 step4~step8 的 SKILL.md
